{"version":3,"sources":["webpack:///webpack/bootstrap d5478efa0c017bedd063","webpack:///./src/index.js","webpack:///external \"botpress-version-manager\"","webpack:///external \"path\"","webpack:///external \"fs\"","webpack:///external \"lodash\"","webpack:///./src/db.js","webpack:///external \"moment\"","webpack:///external \"botpress\"","webpack:///external \"validate-arguments\""],"names":["subscriptions","cached_config","incomingMiddleware","event","next","categoriesText","map","s","category","toUpperCase","join","executeAction","type","action","txt","replace","bp","middlewares","sendOutgoing","platform","text","raw","to","user","id","message","fn","Function","includes","manage_keywords","manage_type","manage_action","exit","forEach","sub","sub_keywords","subscribe","then","sub_action_type","sub_action","catch","unsub_keywords","unsubscribe","unsub_action_type","unsub_action","module","exports","config","required","default","validation","isArray","v","init","__dirname","register","name","handler","order","description","subscription","isSubscribed","getSubscribed","bootstrap","listAll","subs","loadAll","c","ready","router","getRouter","updateSubs","get","req","res","send","post","saveAll","body","sendStatus","put","create","params","modify","delete","Validate","require","db","initialize","listAllSubscription","knex","options","update","remove","userId","createTableIfNotExists","table","increments","primary","timestamp","string","integer","references","schema","mapSubscriptions","JSON","parse","leftJoin","groupBy","select","length","Error","upper","insert","created_on","date","now","stringify","validateOptions","where","del","subscriptionId","ts","args","named","isValid","errorString","pick"],"mappings":"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","file":"node.bundle.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId])\n \t\t\treturn installedModules[moduleId].exports;\n\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\texports: {},\n \t\t\tid: moduleId,\n \t\t\tloaded: false\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.loaded = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"/Users/slvn/Desktop/botpress-subscription\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(0);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap d5478efa0c017bedd063","import checkVersion from 'botpress-version-manager'\n\nimport path from 'path'\nimport fs from 'fs'\nimport _ from 'lodash'\n\nimport db from './db'\n\nlet subscriptions = null\nlet cached_config = null\n\nconst incomingMiddleware = bp => (event, next) => {\n  if (!subscriptions || !cached_config) { \n    return next()\n  }\n\n  const categoriesText = subscriptions.map(s => s.category.toUpperCase()).join(', ')\n  \n  const executeAction = (type, action) => {\n    if (type === 'text') {\n      const txt = action.replace(/{{categories}}/ig, categoriesText)\n\n      bp.middlewares.sendOutgoing({\n        platform: event.platform,\n        type: 'text',\n        text: txt,\n        raw: {\n          to: event.user && event.user.id,\n          message: txt\n        }\n      })\n    } else {\n      let fn = new Function('bp', 'event', 'userId', 'platform', action)\n      fn(bp, event, event.user.id, event.platform)\n    }\n  }\n\n  if (cached_config && _.includes(cached_config.manage_keywords, event.text)) {\n    return executeAction(cached_config.manage_type, cached_config.manage_action)\n  }\n\n  if (subscriptions) {\n    let exit = false\n    subscriptions.forEach(sub => {\n      if (_.includes(sub.sub_keywords, event.text)) {\n        exit = true\n        db(bp).subscribe(event.platform + ':' + event.user.id, sub.category)\n        .then(() => {\n          executeAction(sub.sub_action_type, sub.sub_action)\n        })\n        .catch(next)\n      }\n\n      if (_.includes(sub.unsub_keywords, event.text)) {\n        exit = true\n        db(bp).unsubscribe(event.platform + ':' + event.user.id, sub.category)\n        .then(() => {\n          executeAction(sub.unsub_action_type, sub.unsub_action) \n        })\n        .catch(next)\n      }\n    })\n    if (exit) {\n      return\n    }\n  }\n\n  next()\n}\n\nmodule.exports = {\n\n  config: { \n    manage_keywords: { type: 'any', required: true, default: ['MANAGE_SUBSCRIPTIONS'], validation: v => _.isArray(v) },\n    manage_action: { type: 'string', required: true, default: 'To unsubscribe, type: UNSUBSCRIBE_<CATEGORY>. Categories are: {{categories}}', },\n    manage_type: { type: 'choice', required:true, default: 'text', validation: ['text', 'javascript'] }\n  },\n\n  init: function(bp, config) {\n    checkVersion(bp, __dirname)\n\n    bp.middlewares.register({\n      name: 'manage.subscriptions',\n      type: 'incoming',\n      handler: incomingMiddleware(bp),\n      order: 15,\n      module: 'botpress-subscription',\n      description: 'Subscribes and unsubscribes users to the defined Subscriptions.'\n    })\n\n    bp.subscription = {\n      subscribe: db(bp).subscribe,\n      unsubscribe: db(bp).unsubscribe,\n      isSubscribed: db(bp).isSubscribed,\n      getSubscribed: db(bp).getSubscribed\n    }\n    \n    db(bp).bootstrap()\n    .then(db(bp).listAll)\n    .then(subs => subscriptions = subs)\n\n    config.loadAll()\n    .then(c => cached_config = c)\n  },\n\n  ready: function(bp, config) {\n    const router = bp.getRouter('botpress-subscription')\n    \n    const updateSubs = () => {\n      return db(bp).listAll()\n      .then(subs => subscriptions = subs)\n    }\n\n    router.get('/config', (req, res) => {\n      config.loadAll()\n      .then(c => {\n        cached_config = c\n        res.send(cached_config)\n      })\n    })\n\n    router.post('/config', (req, res) => {\n      config.saveAll(req.body)\n      .then(() => config.loadAll())\n      .then(c => cached_config = c)\n      .then(() => res.sendStatus(200))\n    })\n\n    router.get('/subscriptions', (req, res) => {\n      db(bp).listAll()\n      .then(subs => res.send(subs))\n    })\n\n    router.put('/subscriptions/:category', (req, res) => {\n      db(bp).create(req.params.category)\n      .then(() => res.sendStatus(200))\n      .then(updateSubs)\n    })\n\n    router.post('/subscriptions/:id', (req, res) => {\n      db(bp).modify(req.params.id, req.body)\n      .then(() => res.sendStatus(200))\n      .then(updateSubs)\n    })\n\n    router.delete('/subscriptions/:id', (req, res) => {\n      db(bp).delete(req.params.id)\n      .then(() => res.sendStatus(200))\n      .then(updateSubs)\n    })\n\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/index.js","module.exports = require(\"botpress-version-manager\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"botpress-version-manager\"\n// module id = 2\n// module chunks = 0","module.exports = require(\"path\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"path\"\n// module id = 3\n// module chunks = 0","module.exports = require(\"fs\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"fs\"\n// module id = 4\n// module chunks = 0","module.exports = require(\"lodash\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"lodash\"\n// module id = 5\n// module chunks = 0","import moment from 'moment'\nimport _ from 'lodash'\n\nimport { DatabaseHelpers as helpers } from 'botpress'\n\nconst Validate = require('validate-arguments')\n\nmodule.exports = bp => {\n  return {\n    bootstrap: () => {\n      return bp.db.get()\n      .then(initialize)\n    },\n    listAll: () => {\n      return bp.db.get()\n      .then(listAllSubscription)\n    },\n    create: (category) => {\n      return bp.db.get()\n      .then(knex => create(knex, category))\n    },\n    modify: (id, options) => {\n      return bp.db.get()\n      .then(knex => update(knex, id, options))\n    },\n    delete: (id) => {\n      return bp.db.get()\n      .then(knex => remove(knex, id))\n    },\n    subscribe: (userId, category) => {\n      return bp.db.get()\n      .then(knex => subscribe(knex, userId, category))\n    },\n    unsubscribe: (userId, category) => {\n      return bp.db.get()\n      .then(knex => unsubscribe(knex, userId, category))\n    },\n    isSubscribed: (userId, category) => {\n      return bp.db.get()\n      .then(knex => isSubscribed(knex, userId, category))\n    },\n    getSubscribed: (userId) => {\n      return bp.db.get()\n      .then(knex => getSubscribed(knex, userId))\n    }\n  }\n}\n\nfunction initialize(knex) {\n  return helpers(knex).createTableIfNotExists('subscriptions', function (table) {\n    table.increments('id').primary()\n    table.timestamp('created_on')\n    table.string('category')\n    table.string('sub_keywords')\n    table.string('unsub_keywords')\n    table.string('sub_action')\n    table.string('unsub_action')\n    table.string('sub_action_type')\n    table.string('unsub_action_type')\n  })\n  .then(function() {\n    return helpers(knex).createTableIfNotExists('subscription_users', function (table) {\n      table.integer('subscriptionId').references('subscriptions.id')\n      table.string('userId').references('users.id')\n      table.primary(['subscriptionId', 'userId'])\n      table.timestamp('ts')\n    })\n  })\n  .then(function() {\n    // Query compatible with SQLite3 & Postgres 9.5\n    return knex.schema.raw(`create unique index\n      if not exists \"subscriptions_category_unique\" \n      on \"subscriptions\" (\"category\")`)\n    .then()\n  })\n}\n\nfunction mapSubscriptions(subs) {\n  return subs.map(sub => {\n    sub.sub_keywords = JSON.parse(sub.sub_keywords)\n    sub.unsub_keywords = JSON.parse(sub.unsub_keywords)\n    return sub\n  })\n}\n\nfunction listAllSubscription(knex) {\n  return knex('subscriptions')\n  .leftJoin('subscription_users', 'subscription_users.subscriptionId', 'subscriptions.id')\n  .groupBy('subscriptions.id')\n  .select(knex.raw(`subscriptions.*, count(\"userId\") as count`))\n  .then(mapSubscriptions)\n}\n\nfunction create(knex, category) {\n  if (typeof category !== 'string' || category.length < 1) {\n    throw new Error('Category must be a valid string')\n  }\n\n  const upper = category.toUpperCase()\n\n  return knex('subscriptions')\n  .insert({\n    created_on: helpers(knex).date.now(),\n    category: category,\n    sub_keywords: JSON.stringify(['SUBSCRIBE_' + upper]),\n    unsub_keywords: JSON.stringify(['UNSUBSCRIBE_' + upper]),\n    sub_action: 'Successfully subscribed to ' + category,\n    sub_action_type: 'text',\n    unsub_action: 'You are now unsubscribed from ' + category,\n    unsub_action_type: 'text'\n  })\n}\n\nfunction update(knex, id, options) {\n  options = validateOptions(options)\n\n  return knex('subscriptions')\n  .where('id', id)\n  .update({\n    category: options.category,\n    sub_keywords: JSON.stringify(options.sub_keywords),\n    unsub_keywords: JSON.stringify(options.unsub_keywords),\n    sub_action: options.sub_action,\n    sub_action_type: options.sub_action_type,\n    unsub_action: options.unsub_action,\n    unsub_action_type: options.unsub_action_type\n  })\n}\n\nfunction remove(knex, id) {\n  return knex('subscription_users')\n  .where('subscriptionId', id)\n  .del()\n  .then(() => {\n    return knex('subscriptions')\n    .where('id', id)\n    .del()\n  })\n}\n\nfunction subscribe(knex, userId, category) {\n  return knex('subscriptions')\n  .where('category', category)\n  .then().get(0).then(sub => {\n    if (!sub) {\n      throw new Error('Could not find subscription of category: ' + category)\n    }\n    \n    return knex('subscription_users')\n    .insert({\n      subscriptionId: sub.id,\n      userId: userId,\n      ts: helpers(knex).date.now()\n    })\n  })\n}\n\nfunction unsubscribe(knex, userId, category) {\n  return knex('subscriptions')\n  .where('category', category)\n  .then().get(0).then(sub => {\n    if (!sub) {\n      throw new Error('Could not find subscription of category: ' + category)\n    }\n\n    return knex('subscription_users')\n    .where({\n      subscriptionId: sub.id,\n      userId: userId\n    })\n    .del()\n  })\n}\n\nfunction isSubscribed(knex, userId, category) {\n  return getSubscribed(knex, userId)\n  .then(subs => _.includes(subs, category))\n}\n\nfunction getSubscribed(knex, userId) {\n  return knex('subscription_users')\n  .join('subscriptions', 'subscriptions.id', 'subscription_users.subscriptionId')\n  .where({ userId })\n  .select('category')\n  .then(subs => subs.map(s => s.category))\n}\n\nfunction validateOptions(options) {\n  const args = Validate.named(options, {\n    category: 'string',\n    sub_keywords: 'array',\n    unsub_keywords: 'array',\n    sub_action: 'string',\n    unsub_action: 'string',\n    sub_action_type: 'string',\n    unsub_action_type: 'string'\n  })\n\n  if(!args.isValid()) {\n    throw args.errorString()\n  }\n\n  return _.pick(options, [\n    'category', \n    'sub_keywords', \n    'unsub_keywords',\n    'sub_action',\n    'unsub_action',\n    'sub_action_type',\n    'unsub_action_type'\n  ])\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/db.js","module.exports = require(\"moment\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"moment\"\n// module id = 7\n// module chunks = 0","module.exports = require(\"botpress\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"botpress\"\n// module id = 8\n// module chunks = 0","module.exports = require(\"validate-arguments\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"validate-arguments\"\n// module id = 9\n// module chunks = 0"],"sourceRoot":""}