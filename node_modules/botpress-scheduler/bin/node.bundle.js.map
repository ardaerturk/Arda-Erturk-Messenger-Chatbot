{"version":3,"sources":["webpack:///webpack/bootstrap 203ee99890249c0d2b3a","webpack:///./src/index.js","webpack:///external \"botpress-version-manager\"","webpack:///external \"moment\"","webpack:///external \"lodash\"","webpack:///external \"bluebird\"","webpack:///./src/db.js","webpack:///external \"botpress\"","webpack:///./src/util.js","webpack:///external \"later\"","webpack:///external \"cronstrue\"","webpack:///external \"validate-arguments\"","webpack:///./src/deamon.js"],"names":["module","exports","config","init","bp","__dirname","bootstrap","d","revive","start","ready","router","getRouter","catchError","message","err","res","status","send","get","req","listUpcoming","then","sortBy","schedules","map","s","scheduleOn","scheduledOn","format","enabled","catch","listPrevious","put","create","body","id","events","emit","post","update","sendStatus","delete","query","deleteDone","Validate","require","db","initialize","options","knex","updateTask","taskId","logs","returned","remove","listExpired","scheduleNext","time","reviveAllExecuting","createTableIfNotExists","table","string","primary","boolean","timestamp","increments","references","onDelete","unique","validateCreateOptions","schedule_human","getHumanExpression","schedule_type","schedule","firstOccurence","getNextOccurence","toDate","insert","created_on","date","now","where","includes","finishedOn","del","deleteScheduled","join","dt","whereRaw","isBefore","andWhere","select","scheduleId","coeff","rounded","Date","Math","round","getTime","ts","whereNotNull","args","named","action","isValid","errorString","validateExpression","pick","validateModifyOptions","cronstrue","type","exp","toLowerCase","toString","localTime","sched1","parse","cron","next","add","sched2","text","next2","Error","fromNow","timerInterval","lock","deamon","createDeamon","reschedule","task","resolve","nextOccurence","run","_run","finally","runSingleTask","expired","result","logger","debug","fn","Function","fromDate","untilDate","logsQuery","from","until","limit","order","fields","fromCallback","callback","flattenLogs","file","x","rescheduled","list","mapSeries","error","stack","notifications","level","clearInterval","setInterval","stop"],"mappings":"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","file":"node.bundle.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId])\n \t\t\treturn installedModules[moduleId].exports;\n\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\texports: {},\n \t\t\tid: moduleId,\n \t\t\tloaded: false\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.loaded = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"/Users/slvn/Desktop/botpress-scheduler\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(0);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap 203ee99890249c0d2b3a","import checkVersion from 'botpress-version-manager'\n\nimport moment from 'moment'\nimport _ from 'lodash'\nimport Promise from 'bluebird'\n\nimport db from './db'\nimport deamon from './deamon'\n\nmodule.exports = {\n\n  config: { },\n\n  init: async function(bp) {\n    checkVersion(bp, __dirname)\n    \n    await db(bp).bootstrap()\n    const d = deamon(bp)\n    await d.revive()\n    d.start()\n  },\n\n  ready: function(bp) {\n    const router = bp.getRouter('botpress-scheduler')\n\n    const catchError = res => err => {\n      const message = typeof(err) === 'string' ? err : err.message\n      res.status(500).send({ message })\n    }\n\n    router.get('/schedules/upcoming', (req, res) => {\n      db(bp).listUpcoming()\n      .then(schedules => {\n        res.send(_.sortBy(schedules, 'scheduledOn').map(s => {\n          s.scheduleOn = moment(s.scheduledOn).format()\n          s.enabled = !!s.enabled\n          return s\n        }))\n      })\n      .catch(catchError(res))\n    })\n\n    router.get('/schedules/past', (req, res) => {\n      db(bp).listPrevious()\n      .then(schedules => {\n        res.send(_.sortBy(schedules, s => -s.scheduledOn).map(s => {\n          s.scheduleOn = moment(s.scheduledOn).format()\n          s.enabled = !!s.enabled\n          return s\n        }))\n      })\n      .catch(catchError(res))\n    })\n\n    router.put('/schedules', (req, res) => {\n      db(bp).create(req.body.id, req.body)\n      .then(schedules => {\n        res.send(schedules)\n        bp.events.emit('scheduler.update')\n      })\n      .catch(catchError(res))\n    })\n\n    router.post('/schedules', (req, res) => {\n      db(bp).update(req.body.id, req.body)\n      .then(() => {\n        res.sendStatus(200)\n        bp.events.emit('scheduler.update')\n      })\n      .catch(catchError(res))\n    })\n\n    router.delete('/schedules', (req, res) => {\n      db(bp).delete(req.query.id)\n      .then(() => {\n        res.sendStatus(200)\n        bp.events.emit('scheduler.update')\n      })\n      .catch(catchError(res))\n    })\n\n    router.delete('/done', (req, res) => {\n      db(bp).deleteDone()\n      .then(() => {\n        res.sendStatus(200)\n        bp.events.emit('scheduler.update')\n      })\n      .catch(catchError(res))\n    })\n\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/index.js","module.exports = require(\"botpress-version-manager\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"botpress-version-manager\"\n// module id = 2\n// module chunks = 0","module.exports = require(\"moment\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"moment\"\n// module id = 3\n// module chunks = 0","module.exports = require(\"lodash\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"lodash\"\n// module id = 4\n// module chunks = 0","module.exports = require(\"bluebird\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"bluebird\"\n// module id = 5\n// module chunks = 0","import _ from 'lodash'\nimport { DatabaseHelpers as helpers } from 'botpress'\n\nconst Validate = require('validate-arguments')\n\nimport util from './util.js'\n\nmodule.exports = bp => {\n  return {\n    bootstrap: () => {\n      return bp.db.get()\n      .then(initialize)\n    },\n    create: (id, options) => {\n      return bp.db.get()\n      .then(knex => create(knex, id, options))\n    },\n    update: (id, options) => {\n      return bp.db.get()\n      .then(knex => update(knex, id, options))\n    },\n    updateTask: (taskId, status, logs, returned) => {\n      return bp.db.get()\n      .then(knex => updateTask(knex, taskId, status, logs, returned))\n    },\n    delete: (id) => {\n      return bp.db.get()\n      .then(knex => remove(knex, id))\n    },\n    deleteDone: () => {\n      return bp.db.get()\n      .then(knex => deleteDone(knex))\n    },\n    listUpcoming: () => {\n      return bp.db.get()\n      .then(knex => listUpcoming(knex))\n    },\n    listPrevious: () => {\n      return bp.db.get()\n      .then(knex => listPrevious(knex))\n    },\n    listExpired: () => {\n      return bp.db.get()\n      .then(knex => listExpired(knex))\n    },\n    scheduleNext: (id, time) => {\n      return bp.db.get()\n      .then(knex => scheduleNext(knex, id, time))\n    },\n    reviveAllExecuting: () => {\n      return bp.db.get()\n      .then(knex => reviveAllExecuting(knex))\n    }\n  }\n}\n\nfunction initialize(knex) {\n  return helpers(knex).createTableIfNotExists('scheduler_schedules', function (table) {\n    table.string('id').primary()\n    table.boolean('enabled')\n    table.string('schedule_type')\n    table.string('schedule')\n    table.string('schedule_human')\n    table.timestamp('created_on')\n    table.string('action')\n  })\n  .then(function() {\n    return helpers(knex).createTableIfNotExists('scheduler_tasks', function (table) {\n      table.increments('id')\n      table.string('scheduleId').references('scheduler_schedules.id').onDelete('CASCADE')\n      table.timestamp('scheduledOn')\n      table.string('status')\n      table.string('logs')\n      table.timestamp('finishedOn')\n      table.string('returned')\n      table.unique(['scheduleId', 'scheduledOn'])\n    })\n  })\n}\n\nfunction create(knex, id, options) {\n  options = validateCreateOptions(options)\n\n  options.schedule_human =\n    util.getHumanExpression(options.schedule_type, options.schedule)\n\n  const firstOccurence = util.getNextOccurence(options.schedule_type, options.schedule).toDate()\n\n  return knex('scheduler_schedules').insert({\n    id: id,\n    created_on: helpers(knex).date.now(),\n    ...options\n  })\n  .then(() => {\n    if (options.enabled) {\n      return scheduleNext(knex, id, firstOccurence)\n    }\n  })\n}\n\nfunction update(knex, id, options) {\n  options = validateCreateOptions(options)\n\n  return knex('scheduler_schedules')\n  .where({ id })\n  .update({ ...options })\n  .then()\n}\n\nfunction updateTask(knex, taskId, status, logs, returned) {\n  const options = { status, logs, returned }\n\n  if (_.includes(['done', 'error', 'skipped'], status)) {\n    options.finishedOn = helpers(knex).date.now()\n  }\n\n  return knex('scheduler_tasks')\n  .where({ id: taskId })\n  .update(options)\n  .then()\n}\n\nfunction reviveAllExecuting(knex) {\n  return knex('scheduler_tasks')\n  .where({ status: 'executing' })\n  .update({ status: 'pending' })\n  .then()\n}\n\nfunction remove(knex, id) {\n  return knex('scheduler_schedules')\n  .where({ id })\n  .del()\n  .then(() => deleteScheduled(knex, id))\n}\n\nfunction listUpcoming(knex) {\n  return knex('scheduler_tasks')\n  .where({ status: 'pending' })\n  .join('scheduler_schedules', 'scheduler_tasks.scheduleId', 'scheduler_schedules.id')\n  .then()\n}\n\nfunction listPrevious(knex) {\n  const dt = helpers(knex).date\n\n  return knex('scheduler_tasks')\n  .whereRaw(dt.isBefore('scheduledOn', dt.now()))\n  .andWhere('status', '!=', 'pending')\n  .join('scheduler_schedules', 'scheduler_tasks.scheduleId', 'scheduler_schedules.id')\n  .then()\n}\n\nfunction listExpired(knex) {\n  const dt = helpers(knex).date\n\n  return knex('scheduler_tasks')\n  .whereRaw(dt.isBefore('scheduledOn', dt.now()))\n  .andWhere('status', '=', 'pending')\n  .join('scheduler_schedules', 'scheduler_tasks.scheduleId', 'scheduler_schedules.id')\n  .select(['scheduler_tasks.id as taskId', '*'])\n  .then()\n}\n\nfunction deleteScheduled(knex, id) {\n  return knex('scheduler_tasks')\n  .where({ scheduleId: id })\n  .del()\n  .then()\n}\n\nfunction scheduleNext(knex, id, time) {\n  // Round the time to the nearest 2 seconds\n  const coeff = 1000 * 2\n  const rounded = new Date(Math.round(time.getTime() / coeff) * coeff)\n\n  const ts = helpers(knex).date.format(rounded)\n\n  return knex('scheduler_tasks')\n  .insert({\n    scheduleId: id,\n    scheduledOn: ts,\n    status: 'pending'\n  })\n  .then()\n}\n\nfunction deleteDone(knex) {\n  return knex('scheduler_tasks')\n  .whereNotNull('finishedOn')\n  .del()\n  .then()\n}\n\nfunction validateCreateOptions(options) {\n  const args = Validate.named(options, {\n    enabled: 'boolean',\n    schedule_type: 'string',\n    schedule: 'string',\n    action: 'string'\n  })\n\n  if(!args.isValid()) {\n    throw args.errorString()\n  }\n\n  util.validateExpression(options.schedule_type, options.schedule)\n\n  return _.pick(options, [\n    'enabled', \n    'schedule_type', \n    'schedule',\n    'action'\n  ])\n}\n\nfunction validateModifyOptions(options) {\n  const args = Validate.named(options, {\n    enabled: 'boolean',\n    action: 'string'\n  })\n\n  if(!args.isValid()) {\n    throw args.errorString()\n  }\n\n  return _.pick(options, [\n    'enabled',\n    'action'\n  ])\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/db.js","module.exports = require(\"botpress\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"botpress\"\n// module id = 7\n// module chunks = 0","import moment from 'moment'\nimport later from 'later'\nimport _ from 'lodash'\n\nconst cronstrue = require('cronstrue')\n\nconst getNextOccurence = (type, exp) => {\n  switch(type.toLowerCase()) {\n    case \"cron\":\n      cronstrue.toString(exp) // Validation\n      later.date.localTime()\n      const sched1 = later.parse.cron(exp)\n      const next = later.schedule(sched1).next(1, moment().add(5, 'seconds'))\n      return moment(new Date(next))\n    case \"natural\":\n      later.date.localTime()\n      const sched2 = later.parse.text(exp)\n      const next2 = later.schedule(sched2).next(2, new Date())[1]\n      return moment(new Date(next2))\n    case \"once\":\n      return moment(new Date(exp))\n  }\n}\n\nconst validateExpression = (type, exp) => {\n  if (!_.includes(['cron', 'natural', 'once'], type.toLowerCase())) {\n    throw new Error('Invalid expression type: ' + type)\n  }\n\n  getNextOccurence(type, exp)\n}\n\nconst getHumanExpression = (type, exp) => {\n  switch(type.toLowerCase()) {\n    case \"cron\":\n      return cronstrue.toString(exp)\n    case \"once\":\n      return 'Once, ' + moment(new Date(exp)).fromNow()\n    case \"natural\":\n      return exp\n    default:\n      throw new Error('Unknown type: ' + type)\n  }\n}\n\nmodule.exports = { getNextOccurence, validateExpression, getHumanExpression }\n\n\n// WEBPACK FOOTER //\n// ./src/util.js","module.exports = require(\"later\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"later\"\n// module id = 9\n// module chunks = 0","module.exports = require(\"cronstrue\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"cronstrue\"\n// module id = 10\n// module chunks = 0","module.exports = require(\"validate-arguments\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"validate-arguments\"\n// module id = 11\n// module chunks = 0","import Promise from 'bluebird'\n\nimport db from './db'\nimport util from './util'\nimport moment from 'moment'\nlet timerInterval = null\nlet lock = false\nlet deamon = null\n\nmodule.exports = bp => {\n  if (!deamon) {\n    deamon = createDeamon(bp)\n  }\n\n  return deamon\n}\n\nconst createDeamon = bp => {\n\n  const reschedule = task => {\n    if (task.schedule_type.toLowerCase() === 'once') {\n      return Promise.resolve(null)\n    }\n\n    const nextOccurence = util.getNextOccurence(task.schedule_type, task.schedule).toDate()\n\n    return db(bp).scheduleNext(task.id, nextOccurence)\n  }\n\n  const run = () => {\n    if (lock === true) {\n      return\n    }\n\n    lock = true\n    return _run().finally(() => {\n      lock = false  \n    })\n  }\n\n  const runSingleTask = async expired => {\n\n    await db(bp).updateTask(expired.taskId, 'executing', null, null)\n    \n    let result = null\n\n    if (!expired.enabled) {\n      bp.logger.debug('[scheduler] Skipped task ' + expired.taskId + '. Reason=disabled')\n      await db(bp).updateTask(expired.taskId, 'skipped', null, null)\n      return\n    }\n\n    var fn = new Function('bp', 'task', expired.action)\n      \n    bp.events.emit('scheduler.update')\n    bp.events.emit('scheduler.started', expired)\n\n    const fromDate = new Date()\n    result = await fn(bp, expired)\n    const untilDate = new Date()\n\n    const returned = (result && result.toString && result.toString()) || result\n\n    const logsQuery = {\n      from: fromDate,\n      until: untilDate,\n      limit: 1000,\n      start: 0,\n      order: 'desc',\n      fields: ['message']\n    }\n\n    const logs = await Promise.fromCallback(callback => bp.logger.query(logsQuery, callback))\n      \n    const flattenLogs = (logs && logs.file && logs.file.map(x => x.message) || []).join('\\n')\n    \n    await db(bp).updateTask(expired.taskId, 'done', flattenLogs, returned)\n      \n    bp.events.emit('scheduler.update')\n    bp.events.emit('scheduler.finished', expired)\n  }\n\n  const _run = async () => {\n    const rescheduled = {}\n    const list = await db(bp).listExpired()\n    \n    return Promise.mapSeries(list, expired => {\n\n      return runSingleTask(expired)\n      .catch(err => {\n        bp.logger.error('[scheduler]', err.message, err.stack)\n        bp.notifications.send({\n          message: 'An error occured while running task: ' + expired.taskId + '. Please check the logs for more info.',\n          level: 'error'\n        })\n        return db(bp).updateTask(expired.taskId, 'error', null, null)\n      })\n      .finally(async () => {\n        if (!rescheduled[expired.taskId]) {\n          await reschedule(expired)\n          rescheduled[expired.taskId] = true\n        }\n      })\n    })\n  }\n\n  const revive = () => db(bp).reviveAllExecuting()\n  \n  const start = () => {\n    clearInterval(timerInterval)\n    timerInterval = setInterval(run, 5000)\n  }\n\n  const stop = () => clearInterval(timerInterval)\n\n  return { start, stop, revive }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/deamon.js"],"sourceRoot":""}