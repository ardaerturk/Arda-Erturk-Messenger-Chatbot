{"version":3,"sources":["webpack:///webpack/bootstrap a719cdcffc10a105e446","webpack:///./src/index.js","webpack:///external \"botpress-version-manager\"","webpack:///external \"path\"","webpack:///external \"fs\"","webpack:///external \"lodash\"","webpack:///external \"crypto\"","webpack:///external \"axios\""],"names":["config","service","getClient","create","baseURL","timeout","process","env","BOTPRESS_HTTP_TIMEOUT","headers","accessToken","setService","userId","text","post","query","lang","sessionId","contextAdd","name","lifespan","params","contextRemove","delete","incomingMiddleware","event","next","shortUserId","get","length","createHash","update","digest","includes","type","payload","then","data","result","mode","fulfillment","speech","bp","middlewares","sendOutgoing","platform","raw","to","user","id","message","channelId","channel","options","nlp","Object","assign","context","add","remove","catch","err","error","code","errorType","errorDetails","console","log","stack","logger","warn","module","exports","default","validation","init","configurator","__dirname","register","handler","order","description","loadAll","ready","router","getRouter","req","res","send","body","saveAll","sendStatus"],"mappings":"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","file":"node.bundle.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId])\n \t\t\treturn installedModules[moduleId].exports;\n\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\texports: {},\n \t\t\tid: moduleId,\n \t\t\tloaded: false\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.loaded = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"/Users/slvn/Desktop/botpress-api.ai\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(0);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap a719cdcffc10a105e446","import checkVersion from 'botpress-version-manager'\nimport path from 'path'\nimport fs from 'fs'\nimport _ from 'lodash'\nimport crypto from 'crypto'\n\nimport axios from 'axios'\n\nlet config = null\nlet service = null\n\nconst getClient = () => {\n  return axios.create({\n    baseURL: 'https://api.api.ai/v1',\n    timeout: process.env.BOTPRESS_HTTP_TIMEOUT || 5000,\n    headers: {'Authorization': 'Bearer ' + config.accessToken}\n  })\n}\n\nconst setService = () => {\n  service = (userId, text) => {\n    return getClient().post('/query?v=20170101', {\n      query: text,\n      lang: config.lang,\n      sessionId: userId\n    })\n  }\n}\n\nconst contextAdd = userId => (name, lifespan = 1) => {\n  return getClient().post('/contexts?v=20170101', [\n    { name, lifespan }\n  ], { params: {sessionId: userId } })\n}\n\nconst contextRemove = userId => name => {\n  return getClient().delete('/contexts/' + name, { params: { sessionId: userId } })\n}\n\nconst incomingMiddleware = (event, next) => {\n  let shortUserId = _.get(event, 'user.id') || ''\n  if (shortUserId.length > 36) {\n    shortUserId = crypto.createHash('md5').update(shortUserId).digest(\"hex\")\n  }\n\n  if ([\"message\", \"postback\", \"text\", \"quick_reply\"].includes(event.type)) {\n    \n    service(shortUserId, event.payload || event.text)\n    .then(({data}) => {\n      const {result} = data\n      if (config.mode === 'fulfillment'\n        && result.fulfillment\n        && result.fulfillment.speech\n        && result.fulfillment.speech.length > 0) {\n        event.bp.middlewares.sendOutgoing({\n          type: 'text',\n          platform: event.platform,\n          text: result.fulfillment.speech,\n          raw: {\n            to: event.user.id,\n            message: result.fulfillment.speech,\n            channelId: event.platform !== 'slack' ? null : event.channel.id,\n            options: event.platform !== 'slack' ? null : {}\n          }\n        })\n        return null // swallow the event, don't call next()\n      } else {\n        event.nlp = Object.assign(result, {\n          context: {\n            add: contextAdd(shortUserId),\n            remove: contextRemove(shortUserId)\n          }\n        })\n        next()\n      }\n    })\n    .catch(error => {\n      let err = _.get(error, 'response.data.status')\n        || _.get(error, 'message')\n        || error\n        || 'Unknown error'\n\n      if (err && err.code) {\n        err = '[' + err.code + '] Type:' + err.errorType + ':', err.errorDetails\n      }\n\n      console.log(error.stack)\n\n      event.bp.logger.warn('botpress-api.ai', 'API Error. Could not process incoming text: ' + err);\n      next()\n    })\n  } else {\n    event.nlp = {\n      context: {\n        add: contextAdd(shortUserId),\n        remove: contextRemove(shortUserId)\n      }\n    }\n    \n    next()\n  }\n}\n\nmodule.exports = {\n\n  config: {\n    accessToken: { type: 'string', env: 'APIAI_TOKEN' },\n    lang: { type: 'string', default: 'en' },\n    mode: { type: 'choice', validation: ['fulfillment', 'default'], default: 'default' }\n  },\n\n  init: async function(bp, configurator) {\n    checkVersion(bp, __dirname)\n    \n    bp.middlewares.register({\n      name: 'apiai.incoming',\n      module: 'botpress-api.ai',\n      type: 'incoming',\n      handler: incomingMiddleware,\n      order: 10,\n      description: 'Process natural language in the form of text. Structured data with an action and parameters for that action is injected in the incoming message event.'\n    })\n    \n    config = await configurator.loadAll()\n    setService()\n  },\n\n  ready: async function(bp, configurator) {\n    const router = bp.getRouter('botpress-apiai')\n\n    router.get('/config', async (req, res) => {\n      res.send(await configurator.loadAll())\n    })\n\n    router.post('/config', async (req, res) => {\n      const { accessToken, lang, mode } = req.body\n      await configurator.saveAll({ accessToken, lang, mode })\n      config = await configurator.loadAll()\n      setService()\n      res.sendStatus(200)\n    })\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/index.js","module.exports = require(\"botpress-version-manager\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"botpress-version-manager\"\n// module id = 2\n// module chunks = 0","module.exports = require(\"path\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"path\"\n// module id = 3\n// module chunks = 0","module.exports = require(\"fs\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"fs\"\n// module id = 4\n// module chunks = 0","module.exports = require(\"lodash\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"lodash\"\n// module id = 5\n// module chunks = 0","module.exports = require(\"crypto\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"crypto\"\n// module id = 6\n// module chunks = 0","module.exports = require(\"axios\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"axios\"\n// module id = 7\n// module chunks = 0"],"sourceRoot":""}